--[[
    Script: Fly Menu (Luna Library) - Geliştirilmiş Versiyon
    Author: Gemini (for reallykrak)
    Date: 03.09.2025
    Description: Hata ayıklama ve güvenlik önlemleri eklenmiş, daha stabil çalışan menü.
]]

-- ===================================================================================
-- ||                             GÜVENLİ BAŞLATMA                                  ||
-- ===================================================================================

-- YENİ: Scriptin çalıştığını konsola yazdıralım.
print("Krak's Fly Menu script'i başlatıldı.")

-- YENİ: Oyunun tamamen yüklendiğinden emin olalım.
if not game:IsLoaded() then
    print("Oyun henüz yüklenmedi, bekleniyor...")
    game.Loaded:Wait()
    print("Oyun yüklendi.")
end

-- YENİ: Luna kütüphanesini güvenli bir şekilde yükleyelim (pcall ile)
local Luna, LunaSuccess = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Nebula-Softworks/Luna-Interface-Suite/refs/heads/master/source.lua", true))()
end)

-- YENİ: Kütüphanenin yüklenip yüklenmediğini kontrol edelim.
if not LunaSuccess or not Luna then
    warn("!!! HATA: Luna kütüphanesi yüklenemedi. İnternet bağlantınızı veya exploit'in game:HttpGet özelliğini kontrol edin.")
    -- Eğer kütüphane yüklenmezse, script'in geri kalanı çalışmaz.
    return 
end

print("Luna kütüphanesi başarıyla yüklendi.")

-- Gerekli servisleri ve oyuncu bilgilerini alalım
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- ===================================================================================
-- ||                        KENDİ FONKSİYONLARINI BURAYA YAZ                         ||
-- ===================================================================================
-- Not: Bu fonksiyonların içi, temel bir uçuş mantığı ile doldurulmuştur.

local flyEnabled = false
local flySpeed = 50
local BodyGyro, BodyVelocity

local function getCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function enableFly()
    local Character = getCharacter()
    if not Character or not Character:FindFirstChild("HumanoidRootPart") or not Character:FindFirstChild("Humanoid") then return end
    local Humanoid = Character.Humanoid
    local RootPart = Character.HumanoidRootPart

    if BodyGyro then BodyGyro:Destroy() end
    if BodyVelocity then BodyVelocity:Destroy() end

    BodyGyro = Instance.new("BodyGyro", RootPart)
    BodyGyro.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    BodyGyro.P = 50000

    BodyVelocity = Instance.new("BodyVelocity", RootPart)
    BodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    BodyVelocity.Velocity = Vector3.new(0, 0, 0)
    
    Humanoid.PlatformStand = true
    print("Fly Aktif Edildi!")
end

local function disableFly()
    local Character = getCharacter()
    if not Character or not Character:FindFirstChild("Humanoid") then return end
    
    if BodyGyro then BodyGyro:Destroy() end
    if BodyVelocity then BodyVelocity:Destroy() end
    
    Character.Humanoid.PlatformStand = false
    print("Fly Devre Dışı Bırakıldı!")
end

local function setFlySpeed(newSpeed)
    flySpeed = newSpeed
    print("Yeni Uçuş Hızı: " .. tostring(flySpeed))
end

-- Karakterin hareketini kontrol eden ana döngü
RunService.RenderStepped:Connect(function()
    if flyEnabled and BodyVelocity and BodyGyro then
        local camera = workspace.CurrentCamera
        BodyGyro.CFrame = camera.CFrame
        
        local moveDirection = Vector3.new(0, 0, 0)
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDirection = moveDirection - Vector3.new(0,0,1) end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDirection = moveDirection + Vector3.new(0,0,1) end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDirection = moveDirection - Vector3.new(1,0,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDirection = moveDirection + Vector3.new(1,0,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDirection = moveDirection + Vector3.new(0,1,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDirection = moveDirection - Vector3.new(0,1,0) end

        if moveDirection.Magnitude > 0 then
             BodyVelocity.Velocity = (camera.CFrame:VectorToWorldSpace(moveDirection)).Unit * flySpeed
        else
            BodyVelocity.Velocity = Vector3.new(0,0,0)
        end
    end
end)

-- ===================================================================================
-- ||                             MENÜ TASARIMI (LUNA)                              ||
-- ===================================================================================
-- YENİ: Menü oluşturmayı da pcall içine alalım ki burada bir hata olursa görelim.

local success, err = pcall(function()
    print("Menü arayüzü oluşturuluyor...")

    local Window = Luna.new("Krak's Fly Menu", 500, 380)
    local FlyTab = Window:add_tab("Fly Ayarları", 4483345998)
    local ControlsSection = FlyTab:add_section("Ana Kontroller")

    local flyToggle = ControlsSection:add_toggle("Fly Aktif", flyEnabled, function(toggled)
        flyEnabled = toggled
        if flyEnabled then
            enableFly()
        else
            disableFly()
        end
    end)

    ControlsSection:add_slider("Uçuş Hızı", 10, 1000, flySpeed, function(value)
        local speed = math.floor(value)
        setFlySpeed(speed)
    end)

    ControlsSection:add_keybind("Fly Tuşu (Toggle)", "E", function()
        local newState = not flyEnabled
        flyToggle:set(newState) 
    end)

    ControlsSection:add_label("Fly'ı aç/kapatmak için butonu veya 'E' tuşunu kullanın.")
    ControlsSection:add_label("Yön tuşları: W, A, S, D")
    ControlsSection:add_label("Yükselme/Alçalma: Space / Sol CTRL")
    
    local CreditsTab = Window:add_tab("Hakkında", 5122979213)
    local CreditsSection = CreditsTab:add_section("Geliştiriciler")
    CreditsSection:add_label("Script Sahibi: reallykrak")
    CreditsSection:add_label("UI Tasarımı: Gemini (Google AI)")
    CreditsSection:add_label("UI Kütüphanesi: Luna by Nebula Softworks")

    print("Menü başarıyla oluşturuldu ve ekranda olmalı.")
end)

if not success then
    warn("!!! HATA: Menü oluşturulurken bir sorunla karşılaşıldı!")
    warn("Hata Mesajı: " .. tostring(err))
end